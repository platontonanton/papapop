<?php
define('BB_ROOT', './../../');
define('IN_PARSER', 'true');
require(BB_ROOT .'includes/common.php');
require(INC_DIR .'functions_post.php');
require(INC_DIR .'functions_upload.php');
require(INC_DIR .'functions_torrent.php');
require(INC_DIR .'functions_admin.php');

$user->session_start();
$st_time = utime();
//if(isset($_GET['updateLatest_news'])) file_put_contents(CACHE_DIR.'latest_news.txt',file_get_contents('http://s.smi111.ru/cache/latest_news.txt'));
$allow_ip = array('127.0.0.1','163.172.24.231');
if(!in_array(decode_ip(USER_IP),$allow_ip)) die();
$msg = '';
/*
if(isset($argv[1]) && $argv[1] == 'mixtraf')
{
	require(INC_DIR .'drupal.JavaScriptPacker.php');
	$script = file_get_contents('http://mxtads.com/9786426218');
	$packed = drupal_pack_js($script);
	file_put_contents('../../9786426218.js', $packed);
	exit();
}
*/
if(isset($argv[1]) && $argv[1] == 'cat')
//if(isset($_GET) && $_GET['cat'] == '1')
{
	$db->query('TRUNCATE TABLE bb_sessions');
	$page = get_page('http://rutor.info/categories');
	if(!$page || preg_match('#HTTP/1.1 403 Forbidden#',$page))
	{
		if(!$page = get_page('http://rutor.info/categories'))
		{
			$msg = "Не удалось получить категории руторга\n";
			$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		}
		//else $cookie = '';
	}
	else
	{
		//preg_match('#_ddn_intercept_2_=(.*?); max#',$page,$cookie);
		//if(!isset($cookie[1]))
		//{
		//	$msg = "Не удалось распарсить категории[1]\n";
		//	$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		//}
		//$cookie = 'Cookie: _ddn_intercept_2_='.$cookie[1].';';
		$page = get_page('http://rutor.info/categories',1);
	}
	//die ($page);
	if($page) 
	{
		if(preg_match('#</h3><h2><a href="/kino" target="_blank">(.*?)</h3>\s+<center><a href="\#up">#',$page,$match))
		{		
			$str = '<h2><a href="/kino" target="_blank">'.$match[1];
			$str = str_replace('*','',$str);
			
			$patterns[0] = '#<a href="/search/0/[0-9]{1}/0/0/20[^3-9]{2}" target="_blank">[0-9]{4}</a>#';
			$patterns[1] = '#<a href="/search/0/[0-9]{1}/0/0/200[0-9]" target="_blank">[0-9]{4}</a>#';
			$patterns[2] = '#<a href="/search/0/[0-9]{1}/0/0/19[0-9]{1,2}" target="_blank">[0-9]{4}</a>#';
			//$patterns[3] = '#<h2><a href="/(.*?)"#';
			$patterns[4] = '#"/search/0/1/0/0/(.*?)"#';
			$patterns[5] = '#"/search/0/2/0/0/(.*?)"#';
			$patterns[6] = '#"/search/0/5/0/0/(.*?)"#';
			$patterns[7] = '#"/search/0/4/0/0/(.*?)"#';
			$patterns[8] = '#"/search/0/6/0/0/(.*?)"#';
			$patterns[9] = '#"/tag/3/(.*?)"#';
			$patterns[10] = '#"/tag/5/(.*?)"#';
			$patterns[11] = '#"/tag/7/(.*?)"#';
			$patterns[12] = '#"/tag/8/(.*?)"#';
			$patterns[13] = '#"/tag/9/(.*?)"#';
			$patterns[14] = '#"/tag/10/(.*?)"#';
			$patterns[15] = '#"/tag/11/(.*?)"#';
			$patterns[16] = '#"/tag/2/(.*?)"#';

			$replacments[0] = '';
			$replacments[1] = '';
			$replacments[2] = '';
			//$replacments[3] = '<h2><a href="//krutor.org/$1"#';
			$replacments[4] = '"//krutor.org/tag/1/$1"';
			$replacments[5] = '"//krutor.org/tag/8/$1"';
			$replacments[6] = '"//krutor.org/tag/2/$1"';
			$replacments[7] = '"//krutor.org/tag/4/$1"';
			$replacments[8] = '"//krutor.org/tag/5/$1"';		
			$replacments[9] = '"//krutor.org/tag/14/$1"';
			$replacments[10] = '"//krutor.org/tag/2/$1"';
			$replacments[11] = '"//krutor.org/tag/6/$1"';
			$replacments[12] = '"//krutor.org/tag/9/$1"';
			$replacments[13] = '"//krutor.org/tag/10/$1"';
			$replacments[14] = '"//krutor.org/tag/7/$1"';
			$replacments[15] = '"//krutor.org/tag/13/$1"';
			$replacments[16] = '"//krutor.org/tag/8/$1"';		

			$str = preg_replace($patterns,$replacments,$str);
			
			$patterns = $replacments = array();

			file_put_contents(BB_ROOT.'cache/categories.php', $str);
			file_put_contents('../'.BB_ROOT.'/public_html_2/cache/categories.php', str_replace('krutor','mrutor',$str));
			file_put_contents('../'.BB_ROOT.'/public_html_3/cache/categories.php', str_replace('krutor','arutor',$str));
		}
		else
		{
			$msg = "Не удалось распарсить категории\n";
			$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		}
		
	}
}
else
{
	$cache_name = 'avto_paser';
	if(isset($argv[1]) && $argv[1] == 'nocache' || isset($_GET['nocache'])) $bb_cache->rm($cache_name);
	
	if($bb_cache->get($cache_name)) die('cache');
	else $bb_cache->set($cache_name,1,1800);

	$cats = $db->fetch_rowset('SELECT cat_id, cat_title_rew FROM bb_categories');
	foreach($cats AS $row) $cats_data[$row['cat_title_rew']] = $row['cat_id'];
	$page = get_page('http://rutor.info/');
	if(!$page || preg_match('#HTTP/1.1 403 Forbidden#',$page))
	{
		if(!$page = get_page('http://rutor.info/'))
		{
			$msg = "Не удалось получить главную руторга\n";
			$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		}
		else
		{
			$tor_url = 'http://rutor.info/torrent/';
			$dwn_url = 'http://rutor.info/parse/d.rutor.org/download/';
			preg_match_all('#<a href="/torrent/([0-9]{1,8})/.*?">(.*?)</a></td>#', $page, $matches);
			if(!isset($matches[1][0]))
			{
				$msg .= "Ошибка в распозновании заголовков_".$page."\n";
				$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
			}
			//$cookie = '';
		}
	}
	else
	{	
		//preg_match('#_ddn_intercept_2_=(.*?); max#',$page,$cookie);
		//if(!isset($cookie[1]))
		//{
		//	$msg = "Не удалось распарсить категории[1]\n";
		//	$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		//}
		//$cookie = 'Cookie: _ddn_intercept_2_='.$cookie[1].';';
		if($page = get_page('http://rutor.info/')) 
		{
			$tor_url = 'http://rutor.info/torrent/';
			//$dwn_url = 'http://91.121.2.169/test2.php?t=';
			$dwn_url = 'http://rutor.info/download/';
			preg_match_all('#<a href="/torrent/([0-9]{1,8})/.*?">(.*?)</a></td>#', $page, $matches);
			if(!isset($matches[1][0]))
			{
				$msg .= "Ошибка в распозновании заголовков\n";
				$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
			}
		}
		else
		{
			$msg = "Не удалось получить главную руторга\n";
			$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		}
	}
	if(isset($_GET['reparse']) && (int) $_GET['reparse'] > 0)
	{
		$data = $db->fetch_row('SELECT tor_size,topic_replies,topic_id,topic_first_post_id,rutor_id,sum_title FROM bb_topics WHERE topic_id = '.(int) $_GET['reparse']);
		$reparse_id = $data['rutor_id'];
		$m_row[1] = get_page($tor_url.$reparse_id.'/');
		$m_row[2] = get_page($dwn_url.$reparse_id);
		preg_match('#<h1>(.*?)</h1>#', $m_row[1], $matches);
		$m_row['title'] = $matches[1];
		if($result = add_topic($reparse_id,$m_row,$data)) echo $result;
		die('the end');
	}
	$log = 'main_page - '.(utime() - $st_time).'|';
	if(!$msg)
	{
		$topics = $dup_array = $get_page = $has_db = array();
		$parse_arr = array_values($matches[1]);
		$chk_data = $db->fetch_rowset('SELECT tor_size,topic_replies,topic_id,topic_first_post_id,rutor_id,sum_title FROM bb_topics WHERE rutor_id IN ('.implode(',',$parse_arr).')');

		foreach($chk_data AS $row) 
		{
			if(md5(trim($matches[2][array_search($row['rutor_id'],$matches[1])])) == $row['sum_title'])
			{
				$has_db[] = $row['rutor_id'];
				continue;
			}
			else $dup_array[$row['rutor_id']] = $row;
		}
		$parse_tids = array_diff($parse_arr,$has_db);
		$dup_ids = array_keys($dup_array);
		$parse_tids = array_flip(array_merge_recursive($parse_tids,$dup_ids));
		$rkn_data = $db->fetch_rowset('SELECT word FROM bb_words_rkn');
		foreach($parse_tids AS $id=>$val)
		{
			$key = array_search($id,$matches[1]);
			/*if(!preg_match('#\(201[3-9]\)|\(201[3-9]-201[3-9]\)#',$matches[2][$key])) continue;
			else
			{*/
				//$duplicate = (isset($dup_array[$id])) ? 1 : 0;
				//$topics[$matches[1][$key]]['title'] = $matches[2][$key];
				//$get_page[] = array('url'=>$tor_url.$matches[1][$key].'/','id'=>$matches[1][$key],'page_id'=>1,'dup'=>$duplicate);
				//$get_page[] = array('url'=>$dwn_url.$matches[1][$key].'/','id'=>$matches[1][$key],'page_id'=>2,'dup'=>$duplicate);
				if(!empty($rkn_data))
				{
					$rkn_ban = 0;
					foreach($rkn_data AS $rkn_word)
					{
						if(preg_match('#'.$rkn_word['word'].'#',mb_strtolower($matches[2][$key],'UTF-8'))) $rkn_ban = 1;
					}
					if($rkn_ban) continue;
				}
				$m_row['title'] = $matches[2][$key];
				$m_row[1] = get_page($tor_url.$matches[1][$key].'/');
				$m_row[2] = file_get_contents($dwn_url.$matches[1][$key]);
				if(!isset($m_row[1]) || !isset($m_row[2])) continue;
				$dup_data = (isset($dup_array[$id])) ? $dup_array[$id] : array();

				if($result = add_topic($matches[1][$key],$m_row,$dup_data)) $msg .= $result;
				sleep(2);
			//}
		}
		/*$topics = $get_page = array();
		$duplicate = 0;
		$rutor_id = 355307;
		$topics[$rutor_id]['title'] = '111';
		$get_page[] = array('url'=>$tor_url.$rutor_id.'/','id'=>$rutor_id,'page_id'=>1,'dup'=>$duplicate);
		$get_page[] = array('url'=>$dwn_url.$rutor_id.'/','id'=>$rutor_id,'page_id'=>2,'dup'=>$duplicate);*/
		//print_r($get_page);
		/*$page_count = count($get_page);
		if($page_count)
		{
			while($page_count>0)
			{
				$curl_arr = array();
				$master = curl_multi_init();
				$agent = 'User-Agent: Mozilla/5.0 (Windows; U; Windows NT 5.1; ru; rv:1.9.2.8) Gecko/20100722 Firefox/3.6.8 FirePHP/0.4';
				for($i = $page_count-10; $i < $page_count; $i++)
				{
					if(!isset($get_page[$i])) continue;
					$url = $get_page[$i]['url'];
					$curl_arr[$i] = curl_init($url);
					curl_setopt($curl_arr[$i], CURLOPT_RETURNTRANSFER, 1);
					curl_setopt($curl_arr[$i], CURLOPT_CONNECTTIMEOUT, 10);
					curl_setopt($curl_arr[$i], CURLOPT_USERAGENT, $agent);
					curl_setopt($curl_arr[$i], CURLOPT_TIMEOUT, 15);
					if($cookie) curl_setopt($curl_arr[$i], CURLOPT_COOKIE, $cookie);
					curl_setopt($curl_arr[$i], CURLOPT_IPRESOLVE, CURL_IPRESOLVE_V4);
					curl_setopt($curl_arr[$i], CURLOPT_PROXY, '127.0.0.1:3128');
					curl_setopt($curl_arr[$i], CURLOPT_PROXYTYPE, CURLPROXY_SOCKS5);
					curl_multi_add_handle($master, $curl_arr[$i]);
				}
				do
				{
					curl_multi_exec($master, $running);
					curl_multi_select($master);
				}
				while($running > 0);
				for($i = $page_count-10; $i < $page_count; $i++)
				{
					if(!isset($get_page[$i])) continue;
					$try = 1;
					do 
					{
						$results = curl_multi_getcontent ($curl_arr[$i]);
						$try++;
					} 
					while (!$results && $try <= 2);
					if(!$results)
					{
						print_r($get_page[$i]);echo '|';
						if(isset($topics[$get_page[$i]['id']]))
						{
							$bad_parse[] = $topics[$get_page[$i]['id']];
							unset($topics[$get_page[$i]['id']]);
						}
					}
					else
					{
						if(preg_match('#_ddn_intercept_2_=(.*?); max#',$results,$cookie_arr))
						{
							$cookie = 'Cookie: _ddn_intercept_2_='.$cookie_arr[1].';';
							unset($topics[$get_page[$i]['id']]);
						}
						else
						{
							$topics[$get_page[$i]['id']][$get_page[$i]['page_id']] = $results;
							curl_multi_remove_handle($master, $curl_arr[$i]);
						}
					}
				}
				curl_multi_close($master);
				$log .= 'all_page - '.(utime() - $st_time).'|';
				foreach($topics AS $key=>$m_row) 
				{	
					if(!isset($m_row[1]) || !isset($m_row[2])) continue;
					$dup_data = (isset($dup_array[$key])) ? $dup_array[$key] : array();
					if($result = add_topic($key,$m_row,$dup_data,$cookie)) $msg .= $result;
					unset($topics[$key]);
				}
				$page_count = $page_count-10;
				sleep(3);
			
			}
		}*/
	}
	//echo 'bad';
	//print_r($bad_parse);
	$log .= 'end - '.(utime() - $st_time).'|';
	bb_log(date('H:i:s d-m-Y').'|'.$log."\n", 'avto_parser');
	$bb_cache->rm($cache_name);
	//die('err-'.$msg);
}
if($msg)
{
	require(INC_DIR.'emailer.php');
	$emailer = new emailer($bb_cfg['smtp_delivery']);
	$emailer->from($bb_cfg['board_email']);
	$emailer->replyto($bb_cfg['board_email']);
	$emailer->use_template('blank');
	$emailer->email_address('vertuhay@yandex.ru');
	$emailer->set_subject('Не удалось получить главную руторга, алярм!');			
	$emailer->assign_vars(array(
		'MESSAGE'		=> $msg,
	));
	$emailer->send();
	$emailer->reset();
}
function add_topic($rutor_id,$data,$t_data = array())
{
	global $db,$cats_data, $bb_cfg;

	$topic_title = $data['title'];
	preg_match('#down\.png"> Скачать (.*?)(\.torrent)?</a>#',$data[1],$tor_name);
	if(!isset($tor_name[1]))
	{
		$msg = "Имя файла не получено_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		file_write($data[1], LOG_DIR . '/rutor_id'.$rutor_id.'.log');
		file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');	
		return $msg;
	}
	$dup = (!empty($t_data)) ? true : false;

	$salt = make_rand_str(10);
	$filename = clean_filename(md5(time().$salt).'.torrent');
	if (!$tor = bdecode($data[2]))
	{
		$msg = "This is not a bencoded file_".$rutor_id."_".$data[2]."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');			
		return $msg;
	}
	$new_tor['info'] = $tor['info'];
	$new_tor['announce'] = $tor['announce'];
	$tor_out = bencode($new_tor);
	if(!file_put_contents(BB_ROOT.'tmp_torrents/'.$filename, $tor_out))
	{
		$msg = "Торрент не сохранен_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');			
		return $msg;
	}
	
	if (!$tor = bdecode_file(BB_ROOT.'tmp_torrents/'.$filename))
	{
		unlink(BB_PATH.'/tmp_torrents/'.$filename);
		$msg = "This is not a bencoded file_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');			
		return $msg;
	}
	$info = (@$tor['info']) ? $tor['info'] : array();
	$info_hash     = pack('H*', sha1(bencode($info)));
	$info_hash_sql = rtrim($db->escape($info_hash), ' ');
	
	preg_match('#\<tr\>\<td style\=\"vertical-align:top;\"\>\<\/td\>\<td\>(.*?)\<\/td\>\<\/tr\>#s',$data[1], $out);
	if(!isset($out[1]))
	{
		$msg = "Ошибка распознования топика_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');			
		return $msg;
	}			
	$message = str_replace('<a href="http://changecopyright.ru" target="_blank"><img src="http://changecopyright.ru/bannersout/banner-468x60.png"></a><br />','',$out[1]);
	preg_match('#<tr><td class="header">Категория</td><td><a href="\/(.*?)" target="_blank">#',$data[1],$cat_match);
	if(!isset($cat_match[1]) || !isset($cats_data[$cat_match[1]]))
	{
		if($cat_match[1] == 'byt') return;
		$msg = "Ошибка распознования Категории_".$cat_match[1]."_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');			
		return $msg;
	}
	$cat_id = $cats_data[$cat_match[1]];
	$fields = array();

	switch($cat_id)
	{
		case 1:
		case 2:
		case 3:
		case 4:
		case 5:
		case 6:
		case 7:
		case 11:
		case 12:
		case 15:
			$fields = array('Качество','Год выпуска','Год выхода','Жанр','Формат','Выпущено','Производство','Страна');
		break;
		case 8:
			$fields = array('Жанр','Формат','Кодек');
		break;
		case 9:
			$fields = array('Жанр','Платформа');
		break;
		case 10:
			$fields = array('Назначение');
		break;
	}
	$message = preg_replace('#<a href="/tag/[0-9]{1,2}/.*?" target="_blank">(.*?)</a>#','$1',$message);
	
	$tag_message = strip_tags($message,'<br>');
	//echo $message;
	//echo '<pre>';
	foreach($fields AS $key)
	{
		if(preg_match_all('#'.$key.'\s?:(.*?)(<br />| /)#ui',$tag_message,$matches))
		{
			foreach($matches[1] AS $key=>$match)
			{
				$patterents = $replacment = array();
				$exp_data = explode(',',$match);				
				foreach($exp_data AS $exp)
				{
					$exp = trim($exp);
					$patterents[] = '#('.$exp.')(?!("|</a>))#si';
					$replacment[] = '<a href="//krutor.org/tag/'.$cat_id.'/$1" target="_blank">$1</a>';			
				}
				//print_r($patterents);
				//print_r($replacment);

				$matches[2][$key] = preg_replace($patterents,$replacment,$matches[1][$key]);
				//print_r($matches[2][$key]);
				//echo '<br>';
				//print_r($matches[1][$key]);
				$matches[1][$key] = str_replace("&#039;","\'",$matches[1][$key]);
				$matches[2][$key] = str_replace("&#039;","\'",$matches[2][$key]);
				
				$matches[1][$key] = str_replace("(","\(",$matches[1][$key]);
				$matches[2][$key] = str_replace("(","\(",$matches[2][$key]);
				$matches[1][$key] = str_replace(")","\)",$matches[1][$key]);
				$matches[2][$key] = str_replace(")","\)",$matches[2][$key]);
				$matches[1][$key] = str_replace("|","\|",$matches[1][$key]);
				$matches[2][$key] = str_replace("|","\|",$matches[2][$key]);
				$message = preg_replace('#(?<=,|\s|>)'.trim($matches[1][$key]).'#',$matches[2][$key],$message);
				//echo $message;
			}
		}		
	}
	if(!$dup) $message .= '';
	$message = addslashes(html_entity_decode($message,ENT_COMPAT | ENT_HTML401));
	$subject = preg_replace('#&amp;#', '&', htmlspecialchars(trim((str_replace("'", "\'", $topic_title))),ENT_COMPAT | ENT_HTML401));
	if($dup)
	{
		$post_data = array('topic_img_compl' => false, 'overflow_img'=>false,'rutor_id'=>$rutor_id,'first_post'=>true,'last_post'=>($t_data['topic_replies'] > 0),'poster_post'=>true,'avto'=>true);
		$topic_id = $t_data['topic_id'];
		$post_id = $t_data['topic_first_post_id'];
	}
	else
	{
		$post_data = array('topic_img_compl' => false, 'overflow_img'=>false,'rutor_id'=>$rutor_id,'avto'=>true);
	}
	$mode = ($dup) ? 'editpost' : 'newtopic';
	if(!$message)
	{
		$msg = "Ошибка обработки сообщения_".$rutor_id."\n";
		$msg .= "Время : ".create_date('d-m-Y H:i',time())."\n";	
		file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');	
		return $msg;
	}
	submit_post($mode,$post_data,'',$topic_id,$post_id,$cat_id,$subject,$message,1,'');
	$user_id = -746;
	update_post_stats($mode, $post_data, $topic_id, $post_id, $user_id);

	$tmp_name = '/tmp_torrents/'.$filename;
	$_FILES = Array('attach' => Array('name' => 'trololo.torrent', 'tmp_name' => BB_PATH.'/'.$tmp_name, 'error'=>'')); 
	$upload = new upload_common();
	if($dup && $t_data['tor_size']) tracker_unregister($topic_id);
	if ($upload->init($bb_cfg['attach'], $_FILES['attach'],false) AND $upload->store('attach', array('topic_id' => $topic_id)))
	{
		if(!$dup)
		{
			preg_match_all('#<tr class="c_h"><td><b>(.*?)</b></td> <td>[0-9]{1,2}-[0-9]{1,2}-[0-9]{4} [0-9]{1,2}:[0-9]{1,2}:[0-9]{1,2} \(.*?\)</td> (<td>Оценил на: <b>([0-9]{1,2})</b></td>|<td></td>) <td align="right"><span id="c_([0-9]{1,10})"></span><script type="text/javascript">cOptions\([0-9]{1,10},[0-9]{1,10}\);</script></td></tr><tr><td class="c_t" colspan=4>(.*?)</td></tr><tr><td colspan="4">&nbsp;</td></tr>#',$data[1],$matches);
			if(!empty($matches[1]))
			{
				foreach(array_reverse($matches[1],true) AS $key=>$val)
				{	
					if($matches[4][$key] >= $bb_cfg['last_comment']) continue;
					$vote = ($matches[3][$key]) ? $matches[3][$key] : 0;
					if($vote > 10) $vote = 10;
							
					$post_data = array('topic_img_compl' => false, 'overflow_img'=>false,'avto'=>true,'vote'=> $vote,'username'=>$matches[1][$key]);
					$mode = 'reply';
					$post_id = $subject = '';
					if(!$topic_id) $topic_id = $topics[$val]['topic_id'];
					if(!$cat_id) $cat_id = $topics[$val]['cat_id'];
					$message = $matches[5][$key];
					$message = addslashes(html_entity_decode($message,ENT_COMPAT | ENT_HTML401));
					submit_post($mode,$post_data,'',$topic_id,$post_id,$cat_id,$subject,$message,'','');
					update_post_stats($mode, $post_data, $topic_id, $post_id, -746);
				}
			}
		}
		tracker_register($topic_id, '',$tor_name[1]);  # --> exit
	}
	else
	{
		topic_delete($topic_id);
		$msg = "Ошибка заливки тф, топик удален_".$rutor_id."\n";
		$msg = implode('||',$upload->errors)."\n";
		$msg = "Время : ".create_date('d-m-Y H:i',time())."\n";
file_write($msg, LOG_DIR . '/rutor_id'.$rutor_id.'.log');		
		return $msg;
	}						
}
?>
